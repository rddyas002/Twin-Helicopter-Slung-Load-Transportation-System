<pre class="code">
<span class="srcline"><span class="lineno"><a href="69,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,103" id="srcline103">103</a></span><span class="line"><span class="comment">% implements discrete state differential step</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,104" id="srcline104">104</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S60T7U851">x_next</span>] = projectState(<span class="var type1" id="S61T7U854">x_prev</span>,<span class="var type1" id="S62T37U855">u</span>,<span class="var type1" id="S63T1U856">dt</span>,<span class="var type1" id="S64T6U857">static_acceleration_earth</span>)  </span></span>
<span class="srcline"><span class="lineno"><a href="69,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo" id="T7:U6"><span class="var type1" id="S60T7U860">x_next</span> = <span class="mxinfo" id="T7:U8">zeros(<span class="mxinfo" id="T1:U9">16</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,106" id="srcline106">106</a></span><span class="line">    <span class="comment">% subtract gyro biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,107" id="srcline107">107</a></span><span class="line">    <span class="mxinfo" id="T1:U10"><span class="var type1" id="S66T1U867">wx</span> = <span class="mxinfo" id="T1:U12"><span class="mxinfo" id="T1:U13"><span class="var type1" id="S62T37U870">u</span>(<span class="mxinfo" id="T1:U15">1</span>)</span> - <span class="mxinfo" id="T1:U16"><span class="var type1" id="S61T7U873">x_prev</span>(<span class="mxinfo" id="T1:U18">11</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,108" id="srcline108">108</a></span><span class="line">    <span class="mxinfo" id="T1:U19"><span class="var type1" id="S67T1U877">wy</span> = <span class="mxinfo" id="T1:U21"><span class="mxinfo" id="T1:U22"><span class="var type1" id="S62T37U880">u</span>(<span class="mxinfo" id="T1:U24">2</span>)</span> - <span class="mxinfo" id="T1:U25"><span class="var type1" id="S61T7U883">x_prev</span>(<span class="mxinfo" id="T1:U27">12</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,109" id="srcline109">109</a></span><span class="line">    <span class="mxinfo" id="T1:U28"><span class="var type1" id="S68T1U887">wz</span> = <span class="mxinfo" id="T1:U30"><span class="mxinfo" id="T1:U31"><span class="var type1" id="S62T37U890">u</span>(<span class="mxinfo" id="T1:U33">3</span>)</span> - <span class="mxinfo" id="T1:U34"><span class="var type1" id="S61T7U893">x_prev</span>(<span class="mxinfo" id="T1:U36">13</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,110" id="srcline110">110</a></span><span class="line">    <span class="comment">% subtract accelerometer biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,111" id="srcline111">111</a></span><span class="line">    <span class="mxinfo" id="T1:U37"><span class="var type1" id="S69T1U897">ax</span> = <span class="mxinfo" id="T1:U39"><span class="mxinfo" id="T1:U40"><span class="var type1" id="S62T37U900">u</span>(<span class="mxinfo" id="T1:U42">4</span>)</span> - <span class="mxinfo" id="T1:U43"><span class="var type1" id="S61T7U903">x_prev</span>(<span class="mxinfo" id="T1:U45">14</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,112" id="srcline112">112</a></span><span class="line">    <span class="mxinfo" id="T1:U46"><span class="var type1" id="S70T1U907">ay</span> = <span class="mxinfo" id="T1:U48"><span class="mxinfo" id="T1:U49"><span class="var type1" id="S62T37U910">u</span>(<span class="mxinfo" id="T1:U51">5</span>)</span> - <span class="mxinfo" id="T1:U52"><span class="var type1" id="S61T7U913">x_prev</span>(<span class="mxinfo" id="T1:U54">15</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,113" id="srcline113">113</a></span><span class="line">    <span class="mxinfo" id="T1:U55"><span class="var type1" id="S71T1U917">az</span> = <span class="mxinfo" id="T1:U57"><span class="mxinfo" id="T1:U58"><span class="var type1" id="S62T37U920">u</span>(<span class="mxinfo" id="T1:U60">6</span>)</span> - <span class="mxinfo" id="T1:U61"><span class="var type1" id="S61T7U923">x_prev</span>(<span class="mxinfo" id="T1:U63">16</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,114" id="srcline114">114</a></span><span class="line">    <span class="mxinfo" id="T6:U64"><span class="var type1" id="S72T6U927">accl</span> = <span class="mxinfo" id="T6:U66">[<span class="var type1" id="S69T1U930">ax</span>;<span class="var type1" id="S70T1U932">ay</span>;<span class="var type1" id="S71T1U934">az</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,115" id="srcline115">115</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,116" id="srcline116">116</a></span><span class="line">    <span class="comment">% project position</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,117" id="srcline117">117</a></span><span class="line">    <span class="comment">% p_{k+1} = p_{k} + dt*v_{k}</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,118" id="srcline118">118</a></span><span class="line">    <span class="mxinfo" id="T18:U70"><span class="mxinfo" id="T18:U71"><span class="var type1" id="S60T7U938">x_next</span>(<span class="mxinfo" id="T6:U73"><span class="mxinfo" id="T1:U74">1</span>:<span class="mxinfo" id="T1:U75">3</span></span>)</span> = <span class="mxinfo" id="T6:U76"><span class="mxinfo" id="T6:U77"><span class="var type1" id="S61T7U944">x_prev</span>(<span class="mxinfo" id="T6:U79"><span class="mxinfo" id="T1:U80">1</span>:<span class="mxinfo" id="T1:U81">3</span></span>)</span> + <span class="mxinfo" id="T6:U82"><span class="var type1" id="S63T1U949">dt</span>*<span class="mxinfo" id="T6:U84"><span class="var type1" id="S61T7U951">x_prev</span>(<span class="mxinfo" id="T6:U86"><span class="mxinfo" id="T1:U87">4</span>:<span class="mxinfo" id="T1:U88">6</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,119" id="srcline119">119</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="69,120" id="srcline120">120</a></span><span class="line">    <span class="comment">% project velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,121" id="srcline121">121</a></span><span class="line">    <span class="comment">% v_{k+1} = v_{k} + dt*a_{k}</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,122" id="srcline122">122</a></span><span class="line">    <span class="mxinfo" id="T6:U89"><span class="var type1" id="S73T6U957">raw_accel_earth</span> = <span class="mxinfo" id="T6:U91"><span class="fcn" id="F286N7:B959">Reb</span>(<span class="mxinfo" id="T8:U92"><span class="var type1" id="S61T7U961">x_prev</span>(<span class="mxinfo" id="T8:U94"><span class="mxinfo" id="T1:U95">7</span>:<span class="mxinfo" id="T1:U96">10</span></span>)</span>,<span class="mxinfo" id="T6:U97">[<span class="var type1" id="S69T1U967">ax</span>;<span class="var type1" id="S70T1U969">ay</span>;<span class="var type1" id="S71T1U971">az</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo" id="T6:U101"><span class="var type1" id="S75T6U974">dyn_accel</span> = <span class="mxinfo" id="T6:U103"><span class="var type1" id="S73T6U976">raw_accel_earth</span> - <span class="var type1" id="S64T6U977">static_acceleration_earth</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,124" id="srcline124">124</a></span><span class="line">    <span class="mxinfo" id="T18:U106"><span class="mxinfo" id="T18:U107"><span class="var type1" id="S60T7U981">x_next</span>(<span class="mxinfo" id="T6:U109"><span class="mxinfo" id="T1:U110">4</span>:<span class="mxinfo" id="T1:U111">6</span></span>)</span> = <span class="mxinfo" id="T6:U112"><span class="mxinfo" id="T6:U113"><span class="var type1" id="S61T7U987">x_prev</span>(<span class="mxinfo" id="T6:U115"><span class="mxinfo" id="T1:U116">4</span>:<span class="mxinfo" id="T1:U117">6</span></span>)</span> + <span class="mxinfo" id="T6:U118"><span class="var type1" id="S63T1U992">dt</span>*<span class="var type1" id="S75T6U993">dyn_accel</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,126" id="srcline126">126</a></span><span class="line">    <span class="comment">% project quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,127" id="srcline127">127</a></span><span class="line">    <span class="mxinfo" id="T1:U121"><span class="var type1" id="S76T1U996">q1</span> = <span class="mxinfo" id="T1:U123"><span class="var type1" id="S61T7U998">x_prev</span>(<span class="mxinfo" id="T1:U125">7</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,128" id="srcline128">128</a></span><span class="line">    <span class="mxinfo" id="T1:U126"><span class="var type1" id="S77T1U1002">q2</span> = <span class="mxinfo" id="T1:U128"><span class="var type1" id="S61T7U1004">x_prev</span>(<span class="mxinfo" id="T1:U130">8</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo" id="T1:U131"><span class="var type1" id="S78T1U1008">q3</span> = <span class="mxinfo" id="T1:U133"><span class="var type1" id="S61T7U1010">x_prev</span>(<span class="mxinfo" id="T1:U135">9</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,130" id="srcline130">130</a></span><span class="line">    <span class="mxinfo" id="T1:U136"><span class="var type1" id="S79T1U1014">q4</span> = <span class="mxinfo" id="T1:U138"><span class="var type1" id="S61T7U1016">x_prev</span>(<span class="mxinfo" id="T1:U140">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,131" id="srcline131">131</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,132" id="srcline132">132</a></span><span class="line"><span class="comment">%     lambda = 1-norm([q1,q2,q3,q4]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,133" id="srcline133">133</a></span><span class="line"><span class="comment">%     q_next = quaternionPropagate([q1;q2;q3;q4],[wx;wy;wz],dt,0.1,1e-3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,134" id="srcline134">134</a></span><span class="line"><span class="comment">%     x_next(7) = q_next(1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,135" id="srcline135">135</a></span><span class="line"><span class="comment">%     x_next(8) = q_next(2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,136" id="srcline136">136</a></span><span class="line"><span class="comment">%     x_next(9) = q_next(3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,137" id="srcline137">137</a></span><span class="line"><span class="comment">%     x_next(10) = q_next(4);</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,138" id="srcline138">138</a></span><span class="line">    <span class="mxinfo" id="T1:U141"><span class="mxinfo" id="T1:U142"><span class="var type1" id="S60T7U1021">x_next</span>(<span class="mxinfo" id="T1:U144">7</span>)</span> = <span class="mxinfo" id="T1:U145"><span class="var type1" id="S76T1U1024">q1</span> - <span class="mxinfo" id="T1:U147"><span class="mxinfo" id="T1:U148"><span class="var type1" id="S63T1U1027">dt</span>*<span class="mxinfo" id="T1:U150">0.5</span></span>*(<span class="mxinfo" id="T1:U151"><span class="mxinfo" id="T1:U152"><span class="mxinfo" id="T1:U153"><span class="var type1" id="S77T1U1033">q2</span>*<span class="var type1" id="S66T1U1034">wx</span></span> + <span class="mxinfo" id="T1:U156"><span class="var type1" id="S78T1U1036">q3</span>*<span class="var type1" id="S67T1U1037">wy</span></span></span> + <span class="mxinfo" id="T1:U159"><span class="var type1" id="S79T1U1039">q4</span>*<span class="var type1" id="S68T1U1040">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,139" id="srcline139">139</a></span><span class="line">    <span class="mxinfo" id="T1:U162"><span class="mxinfo" id="T1:U163"><span class="var type1" id="S60T7U1044">x_next</span>(<span class="mxinfo" id="T1:U165">8</span>)</span> = <span class="mxinfo" id="T1:U166"><span class="var type1" id="S77T1U1047">q2</span> + <span class="mxinfo" id="T1:U168"><span class="mxinfo" id="T1:U169"><span class="var type1" id="S63T1U1050">dt</span>*<span class="mxinfo" id="T1:U171">0.5</span></span>*(<span class="mxinfo" id="T1:U172"><span class="mxinfo" id="T1:U173"><span class="mxinfo" id="T1:U174"><span class="var type1" id="S76T1U1056">q1</span>*<span class="var type1" id="S66T1U1057">wx</span></span> - <span class="mxinfo" id="T1:U177"><span class="var type1" id="S79T1U1059">q4</span>*<span class="var type1" id="S67T1U1060">wy</span></span></span> + <span class="mxinfo" id="T1:U180"><span class="var type1" id="S78T1U1062">q3</span>*<span class="var type1" id="S68T1U1063">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo" id="T1:U183"><span class="mxinfo" id="T1:U184"><span class="var type1" id="S60T7U1067">x_next</span>(<span class="mxinfo" id="T1:U186">9</span>)</span> = <span class="mxinfo" id="T1:U187"><span class="var type1" id="S78T1U1070">q3</span> + <span class="mxinfo" id="T1:U189"><span class="mxinfo" id="T1:U190"><span class="var type1" id="S63T1U1073">dt</span>*<span class="mxinfo" id="T1:U192">0.5</span></span>*(<span class="mxinfo" id="T1:U193"><span class="mxinfo" id="T1:U194"><span class="mxinfo" id="T1:U195"><span class="var type1" id="S79T1U1079">q4</span>*<span class="var type1" id="S66T1U1080">wx</span></span> + <span class="mxinfo" id="T1:U198"><span class="var type1" id="S76T1U1082">q1</span>*<span class="var type1" id="S67T1U1083">wy</span></span></span> - <span class="mxinfo" id="T1:U201"><span class="var type1" id="S77T1U1085">q2</span>*<span class="var type1" id="S68T1U1086">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo" id="T1:U204"><span class="mxinfo" id="T1:U205"><span class="var type1" id="S60T7U1090">x_next</span>(<span class="mxinfo" id="T1:U207">10</span>)</span> = <span class="mxinfo" id="T1:U208"><span class="var type1" id="S79T1U1093">q4</span> - <span class="mxinfo" id="T1:U210"><span class="mxinfo" id="T1:U211"><span class="var type1" id="S63T1U1096">dt</span>*<span class="mxinfo" id="T1:U213">0.5</span></span>*(<span class="mxinfo" id="T1:U214"><span class="mxinfo" id="T1:U215"><span class="mxinfo" id="T1:U216"><span class="var type1" id="S78T1U1102">q3</span>*<span class="var type1" id="S66T1U1103">wx</span></span> - <span class="mxinfo" id="T1:U219"><span class="var type1" id="S77T1U1105">q2</span>*<span class="var type1" id="S67T1U1106">wy</span></span></span> - <span class="mxinfo" id="T1:U222"><span class="var type1" id="S76T1U1108">q1</span>*<span class="var type1" id="S68T1U1109">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,142" id="srcline142">142</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="69,143" id="srcline143">143</a></span><span class="line">    <span class="comment">% normalize quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,144" id="srcline144">144</a></span><span class="line">    <span class="mxinfo" id="T19:U225"><span class="mxinfo" id="T19:U226"><span class="var type1" id="S60T7U1113">x_next</span>(<span class="mxinfo" id="T8:U228"><span class="mxinfo" id="T1:U229">7</span>:<span class="mxinfo" id="T1:U230">10</span></span>)</span> = <span class="mxinfo" id="T8:U231"><span class="mxinfo" id="T8:U232"><span class="var type1" id="S60T7U1119">x_next</span>(<span class="mxinfo" id="T8:U234"><span class="mxinfo" id="T1:U235">7</span>:<span class="mxinfo" id="T1:U236">10</span></span>)</span>/<span class="mxinfo" id="T1:U237">norm(<span class="mxinfo" id="T8:U238"><span class="var type1" id="S60T7U1126">x_next</span>(<span class="mxinfo" id="T8:U240"><span class="mxinfo" id="T1:U241">7</span>:<span class="mxinfo" id="T1:U242">10</span></span>)</span>)</span></span></span>;    </span></span>
<span class="srcline"><span class="lineno"><a href="69,145" id="srcline145">145</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,146" id="srcline146">146</a></span><span class="line">    <span class="comment">% project gyro and accel biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,147" id="srcline147">147</a></span><span class="line">    <span class="mxinfo" id="T1:U243"><span class="mxinfo" id="T1:U244"><span class="var type1" id="S60T7U1133">x_next</span>(<span class="mxinfo" id="T1:U246">11</span>)</span> = <span class="mxinfo" id="T1:U247"><span class="var type1" id="S61T7U1136">x_prev</span>(<span class="mxinfo" id="T1:U249">11</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo" id="T1:U250"><span class="mxinfo" id="T1:U251"><span class="var type1" id="S60T7U1141">x_next</span>(<span class="mxinfo" id="T1:U253">12</span>)</span> = <span class="mxinfo" id="T1:U254"><span class="var type1" id="S61T7U1144">x_prev</span>(<span class="mxinfo" id="T1:U256">12</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,149" id="srcline149">149</a></span><span class="line">    <span class="mxinfo" id="T1:U257"><span class="mxinfo" id="T1:U258"><span class="var type1" id="S60T7U1149">x_next</span>(<span class="mxinfo" id="T1:U260">13</span>)</span> = <span class="mxinfo" id="T1:U261"><span class="var type1" id="S61T7U1152">x_prev</span>(<span class="mxinfo" id="T1:U263">13</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,150" id="srcline150">150</a></span><span class="line">    <span class="mxinfo" id="T1:U264"><span class="mxinfo" id="T1:U265"><span class="var type1" id="S60T7U1157">x_next</span>(<span class="mxinfo" id="T1:U267">14</span>)</span> = <span class="mxinfo" id="T1:U268"><span class="var type1" id="S61T7U1160">x_prev</span>(<span class="mxinfo" id="T1:U270">14</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,151" id="srcline151">151</a></span><span class="line">    <span class="mxinfo" id="T1:U271"><span class="mxinfo" id="T1:U272"><span class="var type1" id="S60T7U1165">x_next</span>(<span class="mxinfo" id="T1:U274">15</span>)</span> = <span class="mxinfo" id="T1:U275"><span class="var type1" id="S61T7U1168">x_prev</span>(<span class="mxinfo" id="T1:U277">15</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,152" id="srcline152">152</a></span><span class="line">    <span class="mxinfo" id="T1:U278"><span class="mxinfo" id="T1:U279"><span class="var type1" id="S60T7U1173">x_next</span>(<span class="mxinfo" id="T1:U281">16</span>)</span> = <span class="mxinfo" id="T1:U282"><span class="var type1" id="S61T7U1176">x_prev</span>(<span class="mxinfo" id="T1:U284">16</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,153" id="srcline153">153</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,154" id="srcline154">154</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,155" id="srcline155">155</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,156" id="srcline156">156</a></span><span class="line"><span class="comment">% this function rotates the vector x from the body into the earth using the</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,157" id="srcline157">157</a></span><span class="line"><span class="comment">% quaternion from the standard quaternion time derivative equation</span></span></span>
</pre>
