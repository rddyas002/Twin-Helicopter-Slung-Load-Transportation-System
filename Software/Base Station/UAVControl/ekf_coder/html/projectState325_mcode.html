<pre class="code">
<span class="srcline"><span class="lineno"><a href="71,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,103" id="srcline103">103</a></span><span class="line"><span class="comment">% implements discrete state differential step</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,104" id="srcline104">104</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S60T7U855">x_next</span>] = projectState(<span class="var type1" id="S61T7U858">x_prev</span>,<span class="var type1" id="S62T35U859">u</span>,<span class="var type1" id="S63T1U860">dt</span>,<span class="var type1" id="S64T6U861">static_acceleration_earth</span>)  </span></span>
<span class="srcline"><span class="lineno"><a href="71,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo" id="T7:U6"><span class="var type1" id="S60T7U864">x_next</span> = <span class="mxinfo" id="T7:U8">zeros(<span class="mxinfo" id="T1:U9">16</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,106" id="srcline106">106</a></span><span class="line">    <span class="comment">% subtract gyro biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,107" id="srcline107">107</a></span><span class="line">    <span class="mxinfo" id="T1:U10"><span class="var type1" id="S66T1U871">wx</span> = <span class="mxinfo" id="T1:U12"><span class="mxinfo" id="T1:U13"><span class="var type1" id="S62T35U874">u</span>(<span class="mxinfo" id="T1:U15">1</span>)</span> - <span class="mxinfo" id="T1:U16"><span class="var type1" id="S61T7U877">x_prev</span>(<span class="mxinfo" id="T1:U18">11</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,108" id="srcline108">108</a></span><span class="line">    <span class="mxinfo" id="T1:U19"><span class="var type1" id="S67T1U881">wy</span> = <span class="mxinfo" id="T1:U21"><span class="mxinfo" id="T1:U22"><span class="var type1" id="S62T35U884">u</span>(<span class="mxinfo" id="T1:U24">2</span>)</span> - <span class="mxinfo" id="T1:U25"><span class="var type1" id="S61T7U887">x_prev</span>(<span class="mxinfo" id="T1:U27">12</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,109" id="srcline109">109</a></span><span class="line">    <span class="mxinfo" id="T1:U28"><span class="var type1" id="S68T1U891">wz</span> = <span class="mxinfo" id="T1:U30"><span class="mxinfo" id="T1:U31"><span class="var type1" id="S62T35U894">u</span>(<span class="mxinfo" id="T1:U33">3</span>)</span> - <span class="mxinfo" id="T1:U34"><span class="var type1" id="S61T7U897">x_prev</span>(<span class="mxinfo" id="T1:U36">13</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,110" id="srcline110">110</a></span><span class="line">    <span class="comment">% subtract accelerometer biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,111" id="srcline111">111</a></span><span class="line">    <span class="mxinfo" id="T1:U37"><span class="var type1" id="S69T1U901">ax</span> = <span class="mxinfo" id="T1:U39"><span class="mxinfo" id="T1:U40"><span class="var type1" id="S62T35U904">u</span>(<span class="mxinfo" id="T1:U42">4</span>)</span> - <span class="mxinfo" id="T1:U43"><span class="var type1" id="S61T7U907">x_prev</span>(<span class="mxinfo" id="T1:U45">14</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,112" id="srcline112">112</a></span><span class="line">    <span class="mxinfo" id="T1:U46"><span class="var type1" id="S70T1U911">ay</span> = <span class="mxinfo" id="T1:U48"><span class="mxinfo" id="T1:U49"><span class="var type1" id="S62T35U914">u</span>(<span class="mxinfo" id="T1:U51">5</span>)</span> - <span class="mxinfo" id="T1:U52"><span class="var type1" id="S61T7U917">x_prev</span>(<span class="mxinfo" id="T1:U54">15</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,113" id="srcline113">113</a></span><span class="line">    <span class="mxinfo" id="T1:U55"><span class="var type1" id="S71T1U921">az</span> = <span class="mxinfo" id="T1:U57"><span class="mxinfo" id="T1:U58"><span class="var type1" id="S62T35U924">u</span>(<span class="mxinfo" id="T1:U60">6</span>)</span> - <span class="mxinfo" id="T1:U61"><span class="var type1" id="S61T7U927">x_prev</span>(<span class="mxinfo" id="T1:U63">16</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,114" id="srcline114">114</a></span><span class="line">    <span class="mxinfo" id="T6:U64"><span class="var type1" id="S72T6U931">accl</span> = <span class="mxinfo" id="T6:U66">[<span class="var type1" id="S69T1U934">ax</span>;<span class="var type1" id="S70T1U936">ay</span>;<span class="var type1" id="S71T1U938">az</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,115" id="srcline115">115</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="71,116" id="srcline116">116</a></span><span class="line">    <span class="comment">% project position</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,117" id="srcline117">117</a></span><span class="line">    <span class="comment">% p_{k+1} = p_{k} + dt*v_{k}</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,118" id="srcline118">118</a></span><span class="line">    <span class="mxinfo" id="T17:U70"><span class="mxinfo" id="T17:U71"><span class="var type1" id="S60T7U942">x_next</span>(<span class="mxinfo" id="T17:U73"><span class="mxinfo" id="T1:U74">1</span>:<span class="mxinfo" id="T1:U75">3</span></span>)</span> = <span class="mxinfo" id="T6:U76"><span class="mxinfo" id="T6:U77"><span class="var type1" id="S61T7U948">x_prev</span>(<span class="mxinfo" id="T17:U79"><span class="mxinfo" id="T1:U80">1</span>:<span class="mxinfo" id="T1:U81">3</span></span>)</span> + <span class="mxinfo" id="T6:U82"><span class="var type1" id="S63T1U953">dt</span>*<span class="mxinfo" id="T6:U84"><span class="var type1" id="S61T7U955">x_prev</span>(<span class="mxinfo" id="T17:U86"><span class="mxinfo" id="T1:U87">4</span>:<span class="mxinfo" id="T1:U88">6</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,119" id="srcline119">119</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="71,120" id="srcline120">120</a></span><span class="line">    <span class="comment">% project velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,121" id="srcline121">121</a></span><span class="line">    <span class="comment">% v_{k+1} = v_{k} + dt*a_{k}</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,122" id="srcline122">122</a></span><span class="line">    <span class="mxinfo" id="T6:U89"><span class="var type1" id="S73T6U961">raw_accel_earth</span> = <span class="mxinfo" id="T6:U91"><span class="fcn" id="F311N8:B963">Reb</span>(<span class="mxinfo" id="T9:U92"><span class="var type1" id="S61T7U965">x_prev</span>(<span class="mxinfo" id="T18:U94"><span class="mxinfo" id="T1:U95">7</span>:<span class="mxinfo" id="T1:U96">10</span></span>)</span>,<span class="mxinfo" id="T6:U97">[<span class="var type1" id="S69T1U971">ax</span>;<span class="var type1" id="S70T1U973">ay</span>;<span class="var type1" id="S71T1U975">az</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,123" id="srcline123">123</a></span><span class="line">    <span class="mxinfo" id="T6:U101"><span class="var type1" id="S75T6U978">dyn_accel</span> = <span class="mxinfo" id="T6:U103"><span class="var type1" id="S73T6U980">raw_accel_earth</span> - <span class="var type1" id="S64T6U981">static_acceleration_earth</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,124" id="srcline124">124</a></span><span class="line">    <span class="mxinfo" id="T17:U106"><span class="mxinfo" id="T17:U107"><span class="var type1" id="S60T7U985">x_next</span>(<span class="mxinfo" id="T17:U109"><span class="mxinfo" id="T1:U110">4</span>:<span class="mxinfo" id="T1:U111">6</span></span>)</span> = <span class="mxinfo" id="T6:U112"><span class="mxinfo" id="T6:U113"><span class="var type1" id="S61T7U991">x_prev</span>(<span class="mxinfo" id="T17:U115"><span class="mxinfo" id="T1:U116">4</span>:<span class="mxinfo" id="T1:U117">6</span></span>)</span> + <span class="mxinfo" id="T6:U118"><span class="var type1" id="S63T1U996">dt</span>*<span class="var type1" id="S75T6U997">dyn_accel</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="71,126" id="srcline126">126</a></span><span class="line">    <span class="comment">% project quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,127" id="srcline127">127</a></span><span class="line">    <span class="mxinfo" id="T1:U121"><span class="var type1" id="S76T1U1000">q1</span> = <span class="mxinfo" id="T1:U123"><span class="var type1" id="S61T7U1002">x_prev</span>(<span class="mxinfo" id="T1:U125">7</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,128" id="srcline128">128</a></span><span class="line">    <span class="mxinfo" id="T1:U126"><span class="var type1" id="S77T1U1006">q2</span> = <span class="mxinfo" id="T1:U128"><span class="var type1" id="S61T7U1008">x_prev</span>(<span class="mxinfo" id="T1:U130">8</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo" id="T1:U131"><span class="var type1" id="S78T1U1012">q3</span> = <span class="mxinfo" id="T1:U133"><span class="var type1" id="S61T7U1014">x_prev</span>(<span class="mxinfo" id="T1:U135">9</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,130" id="srcline130">130</a></span><span class="line">    <span class="mxinfo" id="T1:U136"><span class="var type1" id="S79T1U1018">q4</span> = <span class="mxinfo" id="T1:U138"><span class="var type1" id="S61T7U1020">x_prev</span>(<span class="mxinfo" id="T1:U140">10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,131" id="srcline131">131</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="71,132" id="srcline132">132</a></span><span class="line"><span class="comment">%     lambda = 1-norm([q1,q2,q3,q4]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,133" id="srcline133">133</a></span><span class="line"><span class="comment">%     q_next = quaternionPropagate([q1;q2;q3;q4],[wx;wy;wz],dt,0.1,1e-3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,134" id="srcline134">134</a></span><span class="line"><span class="comment">%     x_next(7) = q_next(1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,135" id="srcline135">135</a></span><span class="line"><span class="comment">%     x_next(8) = q_next(2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,136" id="srcline136">136</a></span><span class="line"><span class="comment">%     x_next(9) = q_next(3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,137" id="srcline137">137</a></span><span class="line"><span class="comment">%     x_next(10) = q_next(4);</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,138" id="srcline138">138</a></span><span class="line">    <span class="mxinfo" id="T1:U141"><span class="mxinfo" id="T1:U142"><span class="var type1" id="S60T7U1025">x_next</span>(<span class="mxinfo" id="T1:U144">7</span>)</span> = <span class="mxinfo" id="T1:U145"><span class="var type1" id="S76T1U1028">q1</span> - <span class="mxinfo" id="T1:U147"><span class="mxinfo" id="T1:U148"><span class="var type1" id="S63T1U1031">dt</span>*<span class="mxinfo" id="T1:U150">0.5</span></span>*(<span class="mxinfo" id="T1:U151"><span class="mxinfo" id="T1:U152"><span class="mxinfo" id="T1:U153"><span class="var type1" id="S77T1U1037">q2</span>*<span class="var type1" id="S66T1U1038">wx</span></span> + <span class="mxinfo" id="T1:U156"><span class="var type1" id="S78T1U1040">q3</span>*<span class="var type1" id="S67T1U1041">wy</span></span></span> + <span class="mxinfo" id="T1:U159"><span class="var type1" id="S79T1U1043">q4</span>*<span class="var type1" id="S68T1U1044">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,139" id="srcline139">139</a></span><span class="line">    <span class="mxinfo" id="T1:U162"><span class="mxinfo" id="T1:U163"><span class="var type1" id="S60T7U1048">x_next</span>(<span class="mxinfo" id="T1:U165">8</span>)</span> = <span class="mxinfo" id="T1:U166"><span class="var type1" id="S77T1U1051">q2</span> + <span class="mxinfo" id="T1:U168"><span class="mxinfo" id="T1:U169"><span class="var type1" id="S63T1U1054">dt</span>*<span class="mxinfo" id="T1:U171">0.5</span></span>*(<span class="mxinfo" id="T1:U172"><span class="mxinfo" id="T1:U173"><span class="mxinfo" id="T1:U174"><span class="var type1" id="S76T1U1060">q1</span>*<span class="var type1" id="S66T1U1061">wx</span></span> - <span class="mxinfo" id="T1:U177"><span class="var type1" id="S79T1U1063">q4</span>*<span class="var type1" id="S67T1U1064">wy</span></span></span> + <span class="mxinfo" id="T1:U180"><span class="var type1" id="S78T1U1066">q3</span>*<span class="var type1" id="S68T1U1067">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo" id="T1:U183"><span class="mxinfo" id="T1:U184"><span class="var type1" id="S60T7U1071">x_next</span>(<span class="mxinfo" id="T1:U186">9</span>)</span> = <span class="mxinfo" id="T1:U187"><span class="var type1" id="S78T1U1074">q3</span> + <span class="mxinfo" id="T1:U189"><span class="mxinfo" id="T1:U190"><span class="var type1" id="S63T1U1077">dt</span>*<span class="mxinfo" id="T1:U192">0.5</span></span>*(<span class="mxinfo" id="T1:U193"><span class="mxinfo" id="T1:U194"><span class="mxinfo" id="T1:U195"><span class="var type1" id="S79T1U1083">q4</span>*<span class="var type1" id="S66T1U1084">wx</span></span> + <span class="mxinfo" id="T1:U198"><span class="var type1" id="S76T1U1086">q1</span>*<span class="var type1" id="S67T1U1087">wy</span></span></span> - <span class="mxinfo" id="T1:U201"><span class="var type1" id="S77T1U1089">q2</span>*<span class="var type1" id="S68T1U1090">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo" id="T1:U204"><span class="mxinfo" id="T1:U205"><span class="var type1" id="S60T7U1094">x_next</span>(<span class="mxinfo" id="T1:U207">10</span>)</span> = <span class="mxinfo" id="T1:U208"><span class="var type1" id="S79T1U1097">q4</span> - <span class="mxinfo" id="T1:U210"><span class="mxinfo" id="T1:U211"><span class="var type1" id="S63T1U1100">dt</span>*<span class="mxinfo" id="T1:U213">0.5</span></span>*(<span class="mxinfo" id="T1:U214"><span class="mxinfo" id="T1:U215"><span class="mxinfo" id="T1:U216"><span class="var type1" id="S78T1U1106">q3</span>*<span class="var type1" id="S66T1U1107">wx</span></span> - <span class="mxinfo" id="T1:U219"><span class="var type1" id="S77T1U1109">q2</span>*<span class="var type1" id="S67T1U1110">wy</span></span></span> - <span class="mxinfo" id="T1:U222"><span class="var type1" id="S76T1U1112">q1</span>*<span class="var type1" id="S68T1U1113">wz</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,142" id="srcline142">142</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="71,143" id="srcline143">143</a></span><span class="line">    <span class="comment">% normalize quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,144" id="srcline144">144</a></span><span class="line">    <span class="mxinfo" id="T18:U225"><span class="mxinfo" id="T18:U226"><span class="var type1" id="S60T7U1117">x_next</span>(<span class="mxinfo" id="T18:U228"><span class="mxinfo" id="T1:U229">7</span>:<span class="mxinfo" id="T1:U230">10</span></span>)</span> = <span class="mxinfo" id="T9:U231"><span class="mxinfo" id="T9:U232"><span class="var type1" id="S60T7U1123">x_next</span>(<span class="mxinfo" id="T18:U234"><span class="mxinfo" id="T1:U235">7</span>:<span class="mxinfo" id="T1:U236">10</span></span>)</span>/<span class="mxinfo" id="T1:U237">norm(<span class="mxinfo" id="T9:U238"><span class="var type1" id="S60T7U1130">x_next</span>(<span class="mxinfo" id="T18:U240"><span class="mxinfo" id="T1:U241">7</span>:<span class="mxinfo" id="T1:U242">10</span></span>)</span>)</span></span></span>;    </span></span>
<span class="srcline"><span class="lineno"><a href="71,145" id="srcline145">145</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="71,146" id="srcline146">146</a></span><span class="line">    <span class="comment">% project gyro and accel biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,147" id="srcline147">147</a></span><span class="line">    <span class="mxinfo" id="T1:U243"><span class="mxinfo" id="T1:U244"><span class="var type1" id="S60T7U1137">x_next</span>(<span class="mxinfo" id="T1:U246">11</span>)</span> = <span class="mxinfo" id="T1:U247"><span class="var type1" id="S61T7U1140">x_prev</span>(<span class="mxinfo" id="T1:U249">11</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo" id="T1:U250"><span class="mxinfo" id="T1:U251"><span class="var type1" id="S60T7U1145">x_next</span>(<span class="mxinfo" id="T1:U253">12</span>)</span> = <span class="mxinfo" id="T1:U254"><span class="var type1" id="S61T7U1148">x_prev</span>(<span class="mxinfo" id="T1:U256">12</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,149" id="srcline149">149</a></span><span class="line">    <span class="mxinfo" id="T1:U257"><span class="mxinfo" id="T1:U258"><span class="var type1" id="S60T7U1153">x_next</span>(<span class="mxinfo" id="T1:U260">13</span>)</span> = <span class="mxinfo" id="T1:U261"><span class="var type1" id="S61T7U1156">x_prev</span>(<span class="mxinfo" id="T1:U263">13</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,150" id="srcline150">150</a></span><span class="line">    <span class="mxinfo" id="T1:U264"><span class="mxinfo" id="T1:U265"><span class="var type1" id="S60T7U1161">x_next</span>(<span class="mxinfo" id="T1:U267">14</span>)</span> = <span class="mxinfo" id="T1:U268"><span class="var type1" id="S61T7U1164">x_prev</span>(<span class="mxinfo" id="T1:U270">14</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,151" id="srcline151">151</a></span><span class="line">    <span class="mxinfo" id="T1:U271"><span class="mxinfo" id="T1:U272"><span class="var type1" id="S60T7U1169">x_next</span>(<span class="mxinfo" id="T1:U274">15</span>)</span> = <span class="mxinfo" id="T1:U275"><span class="var type1" id="S61T7U1172">x_prev</span>(<span class="mxinfo" id="T1:U277">15</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,152" id="srcline152">152</a></span><span class="line">    <span class="mxinfo" id="T1:U278"><span class="mxinfo" id="T1:U279"><span class="var type1" id="S60T7U1177">x_next</span>(<span class="mxinfo" id="T1:U281">16</span>)</span> = <span class="mxinfo" id="T1:U282"><span class="var type1" id="S61T7U1180">x_prev</span>(<span class="mxinfo" id="T1:U284">16</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="71,153" id="srcline153">153</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,154" id="srcline154">154</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,155" id="srcline155">155</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="71,156" id="srcline156">156</a></span><span class="line"><span class="comment">% this function rotates the vector x from the body into the earth using the</span></span></span>
<span class="srcline"><span class="lineno"><a href="71,157" id="srcline157">157</a></span><span class="line"><span class="comment">% quaternion from the standard quaternion time derivative equation</span></span></span>
</pre>
